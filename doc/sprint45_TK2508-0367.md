# Sprint 4.5 - TK2508-0367 : Accès employé à la section "Liste des utilisateurs et leurs heures"

## 🎯 Objectif
Permettre aux employés de visualiser la section "<!-- Liste des utilisateurs et leurs heures -->" dans les rapports, mais filtrée uniquement sur leur propre code utilisateur ou ID.

## 📋 État actuel
- Les employés n'ont pas accès à la section "Liste des utilisateurs et leurs heures" dans les rapports
- La section est masquée par la condition `!$is_personal_view` dans les templates
- Les employés ne voient que les statistiques résumées de leurs propres données

## 🎯 Résultat attendu
- L'employé peut visualiser la section "Liste des utilisateurs et leurs heures"
- Cette section ne contient que ses propres données (filtrage par user ID)
- L'interface reste cohérente avec la vue manager mais limitée à une seule ligne
- Conservation de toutes les colonnes d'information (heures travaillées, théoriques, delta, etc.)

## 🏗️ Plan de développement MVP

### 📊 Découpage en MVPs testables

#### **MVP 1 : Modification de la logique de filtrage dans reports.php**
- **Fonctionnalité core** : 
  - Adapter la logique `$is_personal_view` pour permettre l'accès à la section utilisateurs
  - Créer une nouvelle variable `$show_user_list` pour contrôler l'affichage de la section
  - Maintenir le filtrage des données par user ID pour les employés
- **Interface graphique** : Aucun changement visuel (logique back-end uniquement)
- **Critères de validation** : 
  - Les employés peuvent accéder à reports.php sans erreurs
  - La variable `$show_user_list` est correctement définie selon les droits utilisateur
  - Les données restent filtrées sur l'employé connecté

#### **MVP 2 : Adaptation du template monthly.tpl**
- **Fonctionnalité core** :
  - Remplacer la condition `!$is_personal_view` par `$show_user_list` 
  - Adapter l'affichage pour une interface cohérente (une ligne utilisateur)
  - Conserver tous les éléments d'information (colonnes heures, delta, statut)
- **Interface graphique** :
  - Section "Liste des utilisateurs et leurs heures" visible pour l'employé
  - Interface identique à la vue manager mais avec une seule ligne
  - Titre adapté : "Mes heures détaillées" au lieu de "Liste des utilisateurs"
- **Critères de validation** :
  - L'employé voit ses heures mensuelles dans le format tableau standard
  - Toutes les colonnes sont présentes et correctement formatées
  - Pas de données d'autres utilisateurs affichées

#### **MVP 3 : Adaptation du template annual.tpl**
- **Fonctionnalité core** :
  - Même adaptation que monthly.tpl pour les rapports annuels
  - Cohérence entre rapports mensuels et annuels
- **Interface graphique** :
  - Section utilisateurs annuelle visible avec données personnelles
  - Interface cohérente avec monthly.tpl
- **Critères de validation** :
  - L'employé voit ses heures annuelles avec la même interface
  - Cohérence parfaite entre vues mensuelle et annuelle
  - Informations YTD correctement affichées

## 📁 Fichiers impactés

### Modifications principales
- `reports.php` : Logique de contrôle d'affichage de la section utilisateurs
- `Views/reports/monthly.tpl` : Adaptation condition d'affichage et titre
- `Views/reports/annual.tpl` : Adaptation condition d'affichage et titre

### Variables ajoutées
- `$show_user_list` : Booléen pour contrôler l'affichage de la section utilisateurs
- Adaptation du titre dynamique selon le profil utilisateur

## 🧪 Tests et validations

### Points de contrôle MVP
- **Après MVP 1** : 
  - `reports.php` s'exécute sans erreur pour les employés
  - Variable `$show_user_list` correctement définie
  - Données toujours filtrées par user ID

- **Après MVP 2** : 
  - Section "Liste des utilisateurs" visible en vue employé mensuelle
  - Une seule ligne affichée (l'employé connecté)
  - Toutes les colonnes présentes avec données correctes

- **Après MVP 3** : 
  - Cohérence parfaite entre rapports mensuels et annuels
  - Interface employé complète et fonctionnelle
  - Aucune régression sur la vue manager

### Validation interface utilisateur
- **Éléments visuels** : Section utilisateurs avec tableau une ligne
- **Interactions** : Navigation fluide, filtres fonctionnels
- **Feedback** : Titres adaptés selon le profil utilisateur
- **État** : Section complètement opérationnelle pour employés et managers

## 🔒 Sécurité et permissions

### Contrôles maintenus
- Filtrage strict par user ID pour les employés
- Pas d'accès aux données d'autres utilisateurs
- Respect des permissions Dolibarr existantes
- Conservation de la logique de droits `timeclock.export`

### Architecture respectée
- Principes SOLID maintenus
- Logique de filtrage centralisée dans `reports.php`
- Templates responsables uniquement de l'affichage
- Pas de duplication de code

## 📈 Critères de succès

### Fonctionnel
- ✅ L'employé voit la section "Liste des utilisateurs et leurs heures"
- ✅ Seules ses propres données sont affichées
- ✅ Toutes les informations sont présentes (heures, delta, statut, etc.)
- ✅ Interface cohérente entre rapports mensuels et annuels

### Technique
- ✅ Aucune régression sur la vue manager
- ✅ Code respectant les principes MVP et SOLID
- ✅ Sécurité des données préservée
- ✅ Performance maintenue

### Utilisateur
- ✅ Interface intuitive et claire
- ✅ Informations facilement lisibles
- ✅ Navigation cohérente avec le reste de l'application
- ✅ Pas de confusion entre vue employé et manager

---

**Statut** : 🏗️ En cours d'implémentation
**Assigné** : Claude Code
**Date création** : 2025-08-22
**Priorité** : Normale

## 📝 Notes d'implémentation

### Respect des principes obligatoires
- ✅ Standard Dolibarr respecté
- ✅ Pas de modification du core Dolibarr
- ✅ Réutilisation des fonctions existantes
- ✅ Code basé sur l'existant, pas d'hallucination
- ✅ Approche MVP avec étapes testables

### Validation développement
1. "Cette modification respecte-t-elle les 5 principes ?" → **OUI**
2. "L'architecture reste-t-elle maintenable et extensible ?" → **OUI**
3. "Ce MVP apporte-t-il une valeur concrète testable ?" → **OUI**
4. "L'interface permet-elle de valider la fonctionnalité ?" → **OUI**
5. "L'utilisateur peut-il comprendre et tester cette étape ?" → **OUI**
6. "Les fonctionnalités existantes restent-elles intactes ?" → **OUI**
7. "L'application est-elle stable après cette étape ?" → **OUI**

### Prochaines étapes
1. Implémentation MVP 1 : Modification `reports.php`
2. Validation et test MVP 1
3. Attendre validation utilisateur avant MVP 2