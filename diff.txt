/**
 * Create object into database
 *
 * @param  User $user      User that creates
 * @param  bool $notrigger false=launch triggers after, true=disable triggers
 * @return int             <0 if KO, Id of created object if OK
 */
public function create(User $user, $notrigger = false)
{
    global $conf;

    // CORRECTION: Initialiser les champs obligatoires avant l'appel à createCommon
    $now = dol_now();
    
    // S'assurer que tous les champs obligatoires sont définis
    if (empty($this->datec)) {
        $this->datec = $this->db->idate($now);
    }
    
    if (empty($this->entity)) {
        $this->entity = $conf->entity;
    }
    
    if (empty($this->fk_user_creat)) {
        $this->fk_user_creat = $user->id;
    }
    
    // S'assurer que clock_in_time est défini pour les nouveaux enregistrements
    if (empty($this->clock_in_time)) {
        $this->clock_in_time = $this->db->idate($now);
    }
    
    // Référence temporaire si vide
    if (empty($this->ref)) {
        $this->ref = '(PROV)';
    }

    $resultcreate = $this->createCommon($user, $notrigger);

    if ($resultcreate > 0) {
        // Auto-generate reference if needed
        if ($this->ref == '(PROV)') {
            $this->ref = $this->getNextNumRef();
            $this->update($user, true);
        }
    }

    return $resultcreate;
}